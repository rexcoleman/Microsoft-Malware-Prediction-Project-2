# src/feature_engineering/update_metadata.py

import yaml
import numpy as np
from src.config_loader import load_paths

def convert_numpy_to_native(obj):
    if isinstance(obj, (np.integer, np.floating)):
        return obj.item()
    elif isinstance(obj, np.ndarray):
        return obj.tolist()
    elif isinstance(obj, dict):
        return {k: convert_numpy_to_native(v) for k, v in obj.items()}
    elif isinstance(obj, list):
        return [convert_numpy_to_native(i) for i in obj]
    return obj

def load_feature_metadata():
    paths = load_paths()
    with open(paths['config']['feature_metadata'], 'r') as file:
        feature_metadata = yaml.safe_load(file)
    feature_metadata = convert_numpy_to_native(feature_metadata)
    return feature_metadata

def save_feature_metadata(feature_metadata):
    feature_metadata = convert_numpy_to_native(feature_metadata)
    paths = load_paths()
    with open(paths['config']['feature_metadata'], 'w') as file:
        file.write("# config/features_metadata.yaml\n\n")
        yaml.dump(feature_metadata, file, default_flow_style=False)

def update_metadata_with_analysis(feature_metadata, analysis_results):
    for feature, analysis in analysis_results.items():
        if feature in feature_metadata['features']:
            feature_metadata['features'][feature]['data_type'] = analysis['data_type']
            feature_metadata['features'][feature]['inferred_data_type'] = analysis['inferred_data_type']
            feature_metadata['features'][feature]['missing_values'] = f"{analysis['missing_values']}%"
            feature_metadata['features'][feature]['correlation_with_target'] = analysis['correlation_with_target']
            feature_metadata['features'][feature]['distribution'] = analysis['distribution']
            feature_metadata['features'][feature]['data_quality'] = analysis['data_quality']
        else:
            feature_metadata['features'][feature] = {
                'description': '',
                'data_type': analysis['data_type'],
                'importance': '',
                'data_source': '',
                'missing_values': f"{analysis['missing_values']}%",
                'transformation': '',
                'feature_engineering': '',
                'correlation_with_target': analysis['correlation_with_target'],
                'distribution': analysis['distribution'],
                'data_quality': analysis['data_quality'],
                'security_implications': '',
                'inferred_data_type': analysis['inferred_data_type'],
                'classified_data_type': analysis['data_type']
            }
    return feature_metadata
